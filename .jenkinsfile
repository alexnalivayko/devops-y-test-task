def internalTestAgents = [
    [ name: "Python 2.7", image: "python:2.7.18-alpine3.11" ], 
    [ name: "Python 3.2", image: "python:3.2-alpine" ], 
    [ name: "Latest Python", image: "python:latest" ] 
]

def lintTest = [
    [ name: 'flack8', command: 'flake8 ./*.py --format=pylint' ],
    [ name: 'pylint', command: 'pylint ./ --output-format=text' ]
]

def parallelUnitTestsMap = internalTestAgents.collectEntries {
    ["Test's FOR ${ it.name }": runUnitTest(it.name, it.image)]
}

def parallelLintsMap = lintTest.collectEntries {
    ["Lint by ${ it.name }": runLint(it.name, it.command)]
}

pipeline {
    agent any
    options {
        timestamps()
    }
    environment {
        SOURCE_DIR = "src"
        TESTS_DIR = "tests"
    }
    stages {
        stage('Code Lint') {
            steps {
                script {
                    parallel parallelLintsMap
                }
            }
        }

        stage('Unit tests') {
            steps {
                script {
                    parallel parallelUnitTestsMap
                }
            }
        }

        stage ('Call another pipeline') {
            steps {
                echo "call another job"
            }
        }
    }
    post {
        always {
            cleanWs notFailBuild: true
        }
    }
}

def runUnitTest(String pythonVersion, String agentImage) {
    return {
        node {
            docker.image(agentImage).inside() {
                stage ("UNIT for ${ pythonVersion }") {
                    echo "Run unit tests on ${ agentImage } with image ${ pythonVersion }"
                    sh "python --version"
                }
            }
        }
    }
}

def runLint(String frameworkName, String command) {
    return {
        node {
            stage ("Lint by ${ frameworkName }") {
                def response = sh script: command, returnStdout: true
                if(response.trim() != '')
                    error "Lint by \"${ frameworkName }\" failed by errors: \n${ response }"

                echo "Lint by \"${ frameworkName }\" successfully passed"
            }
        }
    }
}